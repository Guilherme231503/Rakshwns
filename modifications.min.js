(() => {
  console.log("%c[MOD] Modifications loaded successfully!", "color: lime; font-weight: bold;");

  // Aguarda o Runner estar definido
  function waitForRunner() {
    if (typeof Runner === "undefined") {
      return setTimeout(waitForRunner, 200);
    }

    // Salva referência original
    const OriginalRunner = Runner;

    // Estende a classe Runner com novos recursos
    Runner = class extends OriginalRunner {
      constructor(...args) {
        super(...args);

        this.hasSpeedBoost = false;
        this.speedBoostEndTime = 0;

        this.currentWeather = "clear";
        this.weatherTimer = 0;

        this.weatherTypes = ["clear", "rain", "fog", "night", "storm"];
        this.weatherEffects = [];

        console.log("%c[MOD] Runner modificado com Power-Ups e Sistema de Clima.", "color: cyan;");
      }

      update(deltaTime, ...rest) {
        super.update(deltaTime, ...rest);
        this.updateWeather(deltaTime);
        this.updatePowerUps(deltaTime);
      }

      // ----- POWER-UP -----
      activateSpeedBoost(duration = 5000, multiplier = 1.5) {
        this.hasSpeedBoost = true;
        this.speedBoostEndTime = Date.now() + duration;
        this.speed *= multiplier;
        console.log("[MOD] Power-Up de velocidade ativado!");
      }

      updatePowerUps() {
        if (this.hasSpeedBoost && Date.now() > this.speedBoostEndTime) {
          this.hasSpeedBoost = false;
          this.speed = 6; // velocidade padrão
          console.log("[MOD] Power-Up de velocidade terminou.");
        }
      }

      // ----- CLIMA -----
      updateWeather(deltaTime) {
        this.weatherTimer += deltaTime;

        // Muda clima a cada 60s
        if (this.weatherTimer > 60000) {
          this.weatherTimer = 0;
          const newWeather = this.weatherTypes[Math.floor(Math.random() * this.weatherTypes.length)];
          this.setWeather(newWeather);
        }

        this.renderWeather();
      }

      setWeather(type) {
        this.currentWeather = type;
        console.log(`[MOD] Clima alterado para: ${type}`);
      }

      renderWeather() {
        const ctx = this.canvasCtx;
        if (!ctx) return;

        switch (this.currentWeather) {
          case "rain":
            this.renderRain(ctx);
            break;
          case "fog":
            ctx.fillStyle = "rgba(255,255,255,0.2)";
            ctx.fillRect(0, 0, this.dimensions.WIDTH, this.dimensions.HEIGHT);
            break;
          case "night":
            ctx.fillStyle = "rgba(0,0,30,0.5)";
            ctx.fillRect(0, 0, this.dimensions.WIDTH, this.dimensions.HEIGHT);
            break;
          case "storm":
            if (Math.random() < 0.005) {
              ctx.fillStyle = "rgba(255,255,255,0.8)";
              ctx.fillRect(0, 0, this.dimensions.WIDTH, this.dimensions.HEIGHT);
            } else {
              ctx.fillStyle = "rgba(0,0,20,0.5)";
              ctx.fillRect(0, 0, this.dimensions.WIDTH, this.dimensions.HEIGHT);
            }
            break;
        }
      }

      renderRain(ctx) {
        if (!this.weatherEffects.length) {
          for (let i = 0; i < 40; i++) {
            this.weatherEffects.push({
              x: Math.random() * this.dimensions.WIDTH,
              y: Math.random() * this.dimensions.HEIGHT,
              len: 10 + Math.random() * 10,
              speed: 5 + Math.random() * 3,
            });
          }
        }

        ctx.strokeStyle = "rgba(150,150,255,0.6)";
        ctx.lineWidth = 1.2;
        for (const drop of this.weatherEffects) {
          ctx.beginPath();
          ctx.moveTo(drop.x, drop.y);
          ctx.lineTo(drop.x, drop.y + drop.len);
          ctx.stroke();

          drop.y += drop.speed;
          if (drop.y > this.dimensions.HEIGHT) {
            drop.y = -10;
            drop.x = Math.random() * this.dimensions.WIDTH;
          }
        }
      }
    };

    console.log("%c[MOD] Overlay ativo: Runner extendido com sucesso!", "color: lime;");
  }

  waitForRunner();
})();
